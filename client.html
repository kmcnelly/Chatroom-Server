<!DOCTYPE html>
<html>
   <head>
      <!-- Style Sheet -->
      <!-- <link rel="stylesheet" href="style.css"> -->
      <style type="text/css">

         h1{
            border: 1px #000 solid;
         }

         /*Login Box*/
         #userInBox{
            float: left;

            height: 100px;
            border: 1px #000 solid;
         }
         /*Keep content hidden before user logs in*/
         #content{
            display: none;
         }
         #chatBox{
            float: left;
         }
         #chatlog{
            height:600px;
            border: 1px #000 solid;
         }

         #usersBox{
            float: right;

            border: 1px #000 solid;
         }

      </style>

      <!-- JQuery -->
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>

     <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
     <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

     <!-- Socket.io -->
      <script src="/socket.io/socket.io.js"></script>
      <script type ="text/javascript">

      var socketio = io.connect();
/* ============================================================================
Background Functions
==============================================================================*/
// emphasis string
      function boldHTML(str) {
        var boldStr = document.createElement("b");
        boldStr.innerHTML = str;
        return boldStr;
      }

      function italicsHTML(str) {
        var itStr = document.createElement("i");
        itStr.innerHTML = str;
        return itStr;
      }


/*Get MESSAGE – receives the chat messages*/
      socketio.on("message_to_client",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));

         if(document.getElementById("bold").checked){

            var str = data['user'] + ': ' + data['message'];

            document.getElementById("chatlog").appendChild(boldHTML(str));
         }
         else{
            document.getElementById("chatlog").appendChild(document.createTextNode(data['user'] + ': ' + data['message']));
         }
         
      });

/*NEW USER MESSAGE – */
      socketio.on("user_entered",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));

         var newUser = '*' + data['user'] + ' has joined ';

         document.getElementById("chatlog").appendChild(italicsHTML(newUser));
      });


/*USER LEFT MESSAGE– */
      socketio.on("user_left",function(data) {

         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));

         var oldUser = '*' + data['user'] + ' disconnected';

         document.getElementById("chatlog").appendChild(italicsHTML(oldUser));
      });




/* WHISPER TO RECIEVER– receives the chat messages*/
      socketio.on("whisperTo",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));
         document.getElementById("chatlog").appendChild(document.createTextNode('<private> '+data['user'] + ': ' + data['message']));
      });

/* WHISPER FROM SENDER– receives the chat messages*/
      socketio.on("whisperFrom",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));
         document.getElementById("chatlog").appendChild(document.createTextNode('<private> => '+data['user'] + ': ' + data['message']));
      });




/*Get Users– Recieves updated user list and displays current users in chat room.
   data – the array of users */
   socketio.on('getUsers', function(data){
      var userString = '';
      for(i=0; i < data.length; i++){
         userString += data[i] + '<br/>'
      }
      
      console.log(userString);
      document.getElementById("usersList").innerHTML = userString;

      //update sendTo List
      document.output.sendTo.options.length = 1;

      var sendTo =document.output.sendTo
      for (i=0; i < data.length; i++){
          sendTo.options[sendTo.options.length]=new Option(data[i], data[i], false, false);
      }
   });

/* ============================================================================
Action Functions
==============================================================================*/
//send New User
      function sendNewUser(){
         var name = document.getElementById("newUser_input").value;

         if(name != ""){
            socketio.emit('new_user', name, function(data){
               if(data){
                  console.log(name + " added");

                  $('#userInBox').hide();
                  $('#content').show();

                  document.getElementById("myName").innerHTML = name;
               }
               else{
                  alert("Invalid Username. Try another!");
               }
            });
         }

         //reset the text box
         document.getElementById("newUser_input").value = "";
      }


// Send Message
      function sendMessage(){
         //message
         var msg = document.getElementById("message_input").value;

         //who is the message going to
         var loc = document.getElementById("location").value;

         if(msg != ""){
            socketio.emit("message_to_server", {message:msg, sendTo:loc});
         }

         document.getElementById("message_input").value = "";

      }

/* ============================================================================
Listeners
==============================================================================*/
      //return key for sending message
      $('#sendMs').click(function(){
         alert("clicked");
         sendMessage();
      });

      //return key for sending message
      $(document).keypress(function(event){
          var keycode = (event.keyCode ? event.keyCode : event.which);
          if(keycode == '13'){
              sendMessage();   
         }
      });


      </script>
<!-- ========================================================================================================================= -->
<!-- HTML -->
<!-- ========================================================================================================================= -->

   </head>

   <body>

      <h1>akIRC - Chatroom</h1>

<!-- Entered  -->
      <div id= "userInBox">
         <p>Username: </p>
         <input type=text" id="newUser_input"/>
         <button onclick="sendNewUser()">Submit</button>
      </div>

<!-- All Content -->
      <div id= "content">

<!-- Chat window and chat input -->
         <div id= "chatBox">
            <input type=text id="message_input"/>
            <button onclick="sendMessage()">Send</button>
            <input type=checkbox id="bold"/>Emphasis

            <form name="output">
               <select name="sendTo" id="location" size="1">
                  <option value="all">All</option>
               </select>
            </form>

            <div id="chatlog"> 
            </div>

         </div>

<!-- Display current users in room -->
         <div id= "usersBox">
            <p><i>Welcome, <span id="myName"></span></i></p>
            <p><u>Users</u>:</p>
            <p id="usersList"></p>
         </div>

      </div>
   </body>
</html>